# 🔴 CRITICAL: MongoDB Authentication Failed

**Error:** `bad auth : authentication failed`  
**Code:** 8000  
**Issue:** Database credentials are incorrect

---

## 🚨 The Problem

### Test Result:
```
❌ Connection test FAILED
Error: bad auth : authentication failed
Code: 8000
```

**Meaning:** MongoDB Atlas is rejecting the username/password combination.

---

## ✅ Solution: Fix Database Credentials

### Step 1: Check MongoDB Atlas Database User

1. Go to: https://cloud.mongodb.com
2. Click on your project
3. Click **"Database Access"** (left sidebar)
4. Look for user: `bazaarMKT`

**Check:**
- [ ] User `bazaarMKT` exists?
- [ ] Password is correct?
- [ ] User has permissions?

---

### Step 2: Reset Password (Recommended)

**In MongoDB Atlas:**

1. Click **"Database Access"**
2. Find user `bazaarMKT`
3. Click **"Edit"** button
4. Click **"Edit Password"**
5. Click **"Autogenerate Secure Password"** OR enter a new password
6. **COPY THE PASSWORD** (you'll need it!)
7. Verify permissions: Should have "Read and write to any database"
8. Click **"Update User"**

---

### Step 3: Update Vercel Environment Variable

**Go to Vercel:**

1. https://vercel.com/dashboard
2. Select project: **bazaarmkt**
3. Settings → Environment Variables
4. Find: `MONGODB_URI`
5. Click **"Edit"**

**Update with NEW password:**

**Format:**
```
mongodb+srv://USERNAME:PASSWORD@cluster0.c8vyia3.mongodb.net/bazarmkt?retryWrites=true&w=majority&appName=Cluster0
```

**Example with new password:**
```
mongodb+srv://bazaarMKT:YOUR_NEW_PASSWORD_HERE@cluster0.c8vyia3.mongodb.net/bazarmkt?retryWrites=true&w=majority&appName=Cluster0
```

**Important:**
- Replace `YOUR_NEW_PASSWORD_HERE` with the password from Step 2
- **NO SPACES** in the URI
- If password has special characters, they need to be URL-encoded:
  - `@` becomes `%40`
  - `#` becomes `%23`
  - `$` becomes `%24`
  - `%` becomes `%25`

6. Click **"Save"**
7. Select: **All environments** (Production, Preview, Development)

---

### Step 4: Redeploy

1. Go to **"Deployments"** tab
2. Click **"..."** on latest deployment
3. Click **"Redeploy"**
4. Wait 1-2 minutes

---

## 🔍 Alternative: Create New Database User

If you can't find the user or want to start fresh:

### In MongoDB Atlas:

1. Click **"Database Access"**
2. Click **"Add New Database User"**
3. Choose **"Password"** authentication
4. Enter:
   - **Username:** `bazaarmkt_prod` (or any name)
   - **Password:** Click "Autogenerate" (COPY THIS!)
5. **Database User Privileges:**
   - Select: **"Read and write to any database"**
6. Click **"Add User"**

### Then Update Vercel:

```
mongodb+srv://bazaarmkt_prod:NEW_AUTOGENERATED_PASSWORD@cluster0.c8vyia3.mongodb.net/bazarmkt?retryWrites=true&w=majority&appName=Cluster0
```

---

## 📋 Complete Checklist

### MongoDB Atlas:

- [ ] Database user exists
- [ ] Username is correct: `bazaarMKT` (case-sensitive!)
- [ ] Password is correct
- [ ] User has "Read and write" permissions
- [ ] Database name is `bazarmkt` (lowercase)
- [ ] Network Access: `0.0.0.0/0` is whitelisted

### Vercel:

- [ ] `MONGODB_URI` environment variable updated
- [ ] All environments selected (Production, Preview, Development)
- [ ] Redeployed after updating
- [ ] Verified deployment succeeded

---

## 🔐 Password Special Characters

If your password contains special characters, encode them:

| Character | Encoded |
|-----------|---------|
| `@` | `%40` |
| `:` | `%3A` |
| `/` | `%2F` |
| `?` | `%3F` |
| `#` | `%23` |
| `[` | `%5B` |
| `]` | `%5D` |
| `$` | `%24` |
| `&` | `%26` |
| `+` | `%2B` |
| `,` | `%2C` |
| `;` | `%3B` |
| `=` | `%3D` |
| `%` | `%25` |
| ` ` (space) | `%20` |

**Example:**
- Password: `MyP@ss#123`
- Encoded: `MyP%40ss%23123`

**Use online URL encoder:** https://www.urlencoder.org/

---

## ✅ Test After Fix

### Test in Vercel Function Logs:

1. After redeploying, visit: `https://www.bazaarmkt.ca/api/health`
2. Go to Vercel Dashboard → Functions → api/index.js → Logs

**Look for:**
```
✅ "MongoDB connected to database: bazarmkt"
✅ "Connection config: maxPool=1"
```

**Not:**
```
❌ "bad auth : authentication failed"
❌ "MongoServerError: Authentication failed"
```

---

## 🎯 Quick Test (Local)

After getting the correct credentials, test locally:

```bash
cd backend

# Test with your NEW credentials
node -e "
const { MongoClient } = require('mongodb');
const uri = 'mongodb+srv://USERNAME:PASSWORD@cluster0.c8vyia3.mongodb.net/bazarmkt?retryWrites=true&w=majority';
const client = new MongoClient(uri, { serverSelectionTimeoutMS: 5000 });

client.connect()
  .then(() => {
    console.log('✅ Authentication successful!');
    return client.db('bazarmkt').listCollections().toArray();
  })
  .then(collections => {
    console.log('✅ Found', collections.length, 'collections');
    console.log('📦 Collections:', collections.map(c => c.name).join(', '));
    return client.close();
  })
  .then(() => console.log('✅ Test complete!'))
  .catch(err => {
    console.error('❌ Error:', err.message);
    process.exit(1);
  });
"
```

**Expected Output:**
```
✅ Authentication successful!
✅ Found 10 collections
📦 Collections: users, products, artisans, orders, ...
✅ Test complete!
```

---

## 🆘 Still Not Working?

### Check MongoDB Atlas Status:

1. Is your cluster running? (not paused)
2. Is your cluster in the same region as before?
3. Is your IP whitelisted? (0.0.0.0/0 should be there)

### Common Issues:

**Issue:** "User not found"
- **Fix:** Create new database user

**Issue:** "Authentication failed"
- **Fix:** Reset password, update Vercel

**Issue:** "Network error"
- **Fix:** Add 0.0.0.0/0 to Network Access

**Issue:** "Cluster is paused"
- **Fix:** Resume cluster in MongoDB Atlas

---

## 📞 Action Required

1. ✅ **Reset password in MongoDB Atlas**
2. ✅ **Copy the new password**
3. ✅ **Update `MONGODB_URI` in Vercel with new password**
4. ✅ **Add database name: `/bazarmkt`** to the URI
5. ✅ **Redeploy in Vercel**
6. ✅ **Test the site**

---

**Priority:** CRITICAL  
**Status:** Awaiting password reset  
**ETA to Fix:** 5 minutes after updating credentials  


